<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." name="adjustCopyTo-preprocess">
  
  <!-- ==========================================
       DITA Community Preprocessing Enhancements
       
       Extends the base DITA OT preprocessing pipeline
       by adding a process to adjust the @copy-to 
       values to ensure unique topics or control
       deliverable-specific anchor IDs (e.g., HTML filenames).
       ========================================== -->
      
  <target name="dc-adjust-copy-to" 
    depends="dc-adjust-copy-to-check" 
    unless="preprocess.dc-adjust-copy-to.skip" 
    description="Adjust copy-to attributes in resolved map">
    
    <dirname property="mappull.workdir" 
      file="${dita.temp.dir}/${user.input.file}"
    />
    
    <condition 
      property="dita.preprocess.reloadstylesheet.adjust-copy-to" 
      value="${dita.preprocess.reloadstylesheet}">
      <not><isset property="dita.preprocess.reloadstylesheet.adjust-copy-to"></isset></not>
    </condition>
    
    <!-- NOTE: This process also generates two job XML files, one with just the new source-to-copy-to
               mappings resulting from the adjustment and one that is the original job.xml updated
               to reflect the adjusted source-to-copy-to mappings.
               
               The changes-only job.xml is copyToChangesJob.xml
               
               The updated job.xml is updatedJob.xml
               
      -->
    <property name="job.xml.dir"  location="${dita.temp.dir}"/>
    <makeurl  property="job.xml.dir.url" file="${job.xml.dir}"/>
    
    <property name="copyToChangesJob.xml" value="copyToChangesJob.xml"/>
    <property name="updatedJob.xml" value="updatedJob.xml"/>
    
    <echo> **** dc-adjust-copy-to: before XSLT: ${dita.plugin.org.dita-community.adjust-copy-to.dir}/xsl/adjustCopyTo.xsl</echo>
    
    <xslt taskname="adjust-copy-to" 
      basedir="${dita.temp.dir}" 
      destdir="${dita.temp.dir}" 
      includesfile="${dita.temp.dir}/${fullditamapfile}" 
      extension=".ditamap.copy-to" 
      classpathref="dost.class.path" 
      reloadstylesheet="${dita.preprocess.reloadstylesheet.adjust-copy-to}"
      style="${dita.plugin.org.dita-community.adjust-copy-to.dir}/xsl/adjustCopyTo.xsl">
      <param name="DITAEXT" expression="${dita.ext}" if="dita.ext"></param>
      <param name="TRANSTYPE" expression="${transtype}"/>
      <param name="job.xml.dir.url" expression="${job.xml.dir.url}"/><!-- URL of directory containing .job.xml file -->
      <param name="copyToChangesJob.filename" expression="${copyToChangesJob.xml}"/>
      <param name="updatedJob.filename" expression="${updatedJob.xml}"/>
      <param name="use-nav-keys" 
             expression="${dc.adjust-copy-to.use-nav-keys}"
             if="dc.adjust-copy-to.use-nav-keys"
      />
      <param name="override-existing-copy-to" 
             expression="${dc.adjust-copy-to.override-existing-copy-to}"
             if="dc.adjust-copy-to.override-existing-copy-to"
      />
      <param name="expand-reltable-refs"
             expression="${dc.adjust-copy-to.expand-reltable-refs}"
             if="dc.adjust-copy-to.expand-reltable-refs"
      />      
      <param name="debug"
             expression="${dc.adjust-copy-to.debug}"
             if="dc.adjust-copy-to.debug"
      />
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
    
    <echo> **** dc-adjust-copy-to: After XSLT</echo>
    
    <!-- Update the resolved map with the one reflecting the
         adjusted copy-tos.
      -->
    <move overwrite="true" todir="${dita.temp.dir}">
      <fileset dir="${dita.temp.dir}" includes="**/*.ditamap.copy-to"/>
      <mapper type="glob" from="*.ditamap.copy-to" to="*.ditamap"/>
    </move>
    <!-- Do preprocessing for any new source-to-copy-to mappings:
      
      -->
    <!--
    <move overwrite="true" tofile="${job.xml.dir}/.job.xml"
      file="${job.xml.dir}/${copyToChangesJob.xml}"
    />
    -->    
    
    <!-- Now do the processing -->
    <!-- TBD -->

    <!-- Update the full .job.xml file to reflect the adjusted copy-to
         mapping.
      
      -->
    <!--
    <move overwrite="true" tofile="${job.xml.dir}/.job.xml"
      file="${job.xml.dir}/${updatedJob.xml}"
    />
    -->
  </target>
  
  <target name="dc-adjust-copy-to-check">
    <condition property="preprocess.dc-adjust-copy-to.skip">
      <isset property="noMap"></isset>
    </condition>
  </target>


</project>