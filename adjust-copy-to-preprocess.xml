<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." name="adjustCopyTo-preprocess">
  
  <!-- ==========================================
       DITA Community Preprocessing Enhancements
       
       Extends the base DITA OT preprocessing pipeline
       by adding a process to adjust the @copy-to 
       values to ensure unique topics or control
       deliverable-specific anchor IDs (e.g., HTML filenames).
       ========================================== -->
  
    <target name="dc-preprocess" description="DITA Community preprocessing extensions"
      depends="
                gen-list,
                debug-filter,
                copy-files,
                conrefpush,
                conref,
                move-meta-entries,
                keyref,
                coderef,
                mapref,
                mappull,
                dc-adjust-copy-to,
                chunk,
                maplink,
                move-links,
                topicpull,
                flag-module"
      >
      <!-- This target replaces the base OT preprocess. 
      
           Adds D4P adjust copy-to processing after mappull step.
      -->
    </target>
  
  <target name="dc-adjust-copy-to" 
    depends="dc-adjust-copy-to-check" 
    unless="preprocess.dc-adjust-copy-to.skip" 
    description="Adjust copy-to attributes in resolved map">

    <dirname property="mappull.workdir" 
      file="${dita.temp.dir}/${user.input.file}"
    />
    
    <condition 
      property="dita.preprocess.reloadstylesheet.adjust-copy-to" 
      value="${dita.preprocess.reloadstylesheet}">
      <not><isset property="dita.preprocess.reloadstylesheet.adjust-copy-to"></isset></not>
    </condition>
    
    <xslt taskname="adjust-copy-to" 
      basedir="${dita.temp.dir}" 
      destdir="${dita.temp.dir}" 
      includesfile="${dita.temp.dir}/${fullditamapfile}" 
      extension=".ditamap.copy-to" 
      classpathref="dost.class.path" 
      reloadstylesheet="${dita.preprocess.reloadstylesheet.adjust-copy-to}"
      style="${dita.plugin.org.dita-community.adjust-copy-to.dir}/xsl/adjustCopyTo.xsl">
      <param name="DITAEXT" expression="${dita.ext}" if="dita.ext"></param>
      <param name="TRANSTYPE" expression="${transtype}"/>
      <param name="use-nav-keys" 
             expression="${dc.adjust-copy-to.use-nav-keys}"
             if="dc.adjust-copy-to.use-nav-keys"
      />
      <param name="override-existing-copy-to" 
             expression="${dc.adjust-copy-to.override-existing-copy-to}"
             if="dc.adjust-copy-to.override-existing-copy-to"
      />
      <param name="expand-reltable-refs"
             expression="${dc.adjust-copy-to.expand-reltable-refs}"
             if="dc.adjust-copy-to.expand-reltable-refs"
      />      
      <param name="debug"
             expression="${dc.adjust-copy-to.debug}"
             if="dc.adjust-copy-to.debug"
      />
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
    <move overwrite="true" todir="${dita.temp.dir}">
      <fileset dir="${dita.temp.dir}" includes="**/*.ditamap.copy-to"/>
      <mapper type="glob" from="*.ditamap.copy-to" to="*.ditamap"/>
    </move>
  </target>
  
  <target name="dc-adjust-copy-to-check">
    <condition property="preprocess.dc-adjust-copy-to.skip">
      <isset property="noMap"></isset>
    </condition>
  </target>

</project>